name: Publish Docker Image

on:
  push:
    branches:
      - master
  workflow_dispatch: 

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 1. Normalize repository and branch names to lowercase
      - name: Prepare Docker Metadata
        id: prep
        run: |
          # Convert repo name and branch to lowercase
          REPO_LC=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          BRANCH_LC=$(echo "${{ github.ref_name }}" | tr '[:upper:]' '[:lower:]' | sed 's/\//-/g')
          
          echo "repo=${REPO_LC}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH_LC}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT        

      - name: Get current date for tag
        id: date
        run: echo "NOW=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
        id: get_branch

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # Use the normalized outputs from the 'prep' step
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ steps.prep.outputs.repo }}:${{ steps.prep.outputs.branch }}-${{ steps.prep.outputs.date }}
            ${{ github.ref == 'refs/heads/master' && format('{0}/{1}:latest', secrets.DOCKER_USERNAME, steps.prep.outputs.repo) || '' }}
